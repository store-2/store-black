<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>black store</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="all-css.css" />
    <script type="module">
        import { app, db } from './scripts/my-firebase-app/src/firebase-config.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        async function fetchApps() {
            const appsCollection = collection(db, "apps");
            const appSnapshot = await getDocs(appsCollection);
            const appsList = appSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // تعيين البيانات كمصدر عالمي ليمكن بقية السكربت الوصول إليها
            window.apps = appsList;

            renderApps('suggestedApps', appsList.slice(0, 4), 'row');
            renderApps('newGames', appsList.filter(a => a.name.includes('كاندي') || a.name.includes('سبوتيفاي')), 'row');
            renderApps('topDownloads', appsList, 'grid');
            renderApps('topRated', appsList.slice().sort((a,b) => (b.rating || 0) - (a.rating || 0)), 'grid');
            renderApps('gameCategories', appsList.filter(a => a.name.includes('كاندي') || a.name.includes('تيك')), 'grid');
            renderApps('appCategories', appsList.filter(a => !a.name.includes('كاندي')), 'grid');
        }

        window.addEventListener('DOMContentLoaded', fetchApps);
    </script>
</head>
<body>
    <!-- الشريط العلوي -->
    <div class="top-bar">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="ابحث عن تطبيقات، ألعاب..." id="searchInput"/>
        </div>
        <i class="fas fa-bars" id="menuToggle"></i>
        <div class="profile"></div>
    </div>
    <!-- القائمة الجانبية -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="https://via.placeholder.com/50" alt="شعار" class="logo">
            <h3>المتجر</h3>
        </div>
        <div class="sidebar-menu">
            <a href="index.html" class="menu-item active">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </a>
            <a href="games.html" class="menu-item">
                <i class="fas fa-gamepad"></i>
                <span>الألعاب</span>
            </a>
            <a href="apps.html" class="menu-item">
                <i class="fas fa-mobile-alt"></i>
                <span>التطبيقات</span>
            </a>
            <a href="daownlods.html" class="menu-item">
                <i class="fas fa-chart-line"></i>
                <span>الأكثر تحميلاً</span>
            </a>
            <a href="stars.html" class="menu-item">
                <i class="fas fa-star"></i>
                <span>المفضلة</span>
            </a>
            <a href="staign.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>الإعدادات</span>
            </a>
        </div>
    </div>
    <!-- ...باقي الكود الموجود... -->

    <!-- المحتوى الرئيسي -->
    <div class="container" id="mainContent">

        <!-- الصفحة الرئيسية -->
        <div id="home" class="tab-content active">

            <div class="section">
                <div class="section-title">تطبيقات مقترحة لك <span class="see-all">عرض الكل</span></div>
                <div class="apps-row" id="suggestedApps"></div>
            </div>

            <div class="section">
                <div class="section-title">ألعاب جديدة ومحدثة <span class="see-all">عرض الكل</span></div>
                <div class="apps-row" id="newGames"></div>
            </div>

            <div class="section">
                <div class="section-title">الأكثر تنزيلًا <span class="see-all">عرض الكل</span></div>
                <div class="apps-grid" id="topDownloads"></div>
            </div>

        </div>

        <!-- صفحة الألعاب -->
        <div id="games" class="tab-content">
            <div class="section">
                <div class="section-title">فئات الألعاب</div>
                <div class="apps-grid" id="gameCategories"></div>
            </div>
        </div>

        <!-- صفحة التطبيقات -->
        <div id="apps" class="tab-content">
            <div class="section">
                <div class="section-title">فئات التطبيقات</div>
                <div class="apps-grid" id="appCategories"></div>
            </div>
        </div>

        <!-- صفحة الأعلى تقييمًا -->
        <div id="top" class="tab-content">
            <div class="section">
                <div class="section-title">أفضل التطبيقات والألعاب</div>
                <div class="apps-grid" id="topRated"></div>
            </div>
        </div>

        <!-- صفحة نتائج البحث -->
        <div id="search" class="tab-content">
            <div class="section">
                <div class="section-title">نتائج البحث</div>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

    </div>

    <!-- صفحة التطبيق -->
    <div class="app-page" id="appPage">
        <div class="app-header">
            <img id="appIcon" src="" alt="أيقونة التطبيق">
            <div class="app-header-info">
                <h1 id="appName"></h1>
                <p id="appDev"></p>
                <div class="app-rating">
                    <span id="appStars"></span> <span id="appRating"></span>
                </div>
                <button class="install-btn">تثبيت</button>
            </div>
        </div>
        <div class="app-details">
            <div class="screenshots" id="screenshots"></div>
            <div class="description" id="appDesc"></div>

            <div class="reviews">
                <h3>تقييمات المستخدمين</h3>
                <div id="reviewsList"></div>
            </div>
        </div>
    </div>

    <!-- التنقل السفلي -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="nav-item" data-tab="games"><i class="fas fa-gamepad"></i> ألعاب</div>
        <div class="nav-item" data-tab="apps"><i class="fas fa-th"></i> تطبيقات</div>
        <div class="nav-item"><i class="fas fa-trophy"></i> الأعلى</div>
    </div>

    <script>

        // إضافة دالة لإظهار حالة التحميل
        function showLoading(container) {
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>جاري التحميل...</span>
                </div>
            `;
        }

        // عرض التطبيقات
        function renderApps(containerId, appsList, type = 'row') {
            const container = document.getElementById(containerId);
            showLoading(container);
            
            setTimeout(() => {
                container.innerHTML = '';
                appsList.forEach(app => {
                    const card = document.createElement('div');
                    card.className = type === 'row' ? 'app-card' : 'app-card';
                    card.innerHTML = `
                        <img src="${app.icon}" alt="${app.name}" class="app-icon">
                        <div class="app-info">
                            <div class="app-name">${app.name}</div>
                            <div class="app-dev">${app.dev}</div>
                            <div class="app-rating">
                                <span class="stars">${'★'.repeat(Math.floor(app.rating))}${'☆'.repeat(5 - Math.floor(app.rating))}</span>
                                <span>${app.rating}</span>
                            </div>
                        </div>
                    `;
                    card.onclick = () => openApp(app.id);
                    container.appendChild(card);
                });
            }, 500);
        }

        // فتح صفحة التطبيق (تعديل: زر التثبيت يوجه إلى search.html)
        function openApp(id) {
            const app = apps.find(a => a.id === id);
            if (!app) return;

            // إضافة زر الرجوع في بداية app-header
            const appPage = document.getElementById('appPage');
            const backButton = document.createElement('button');
            backButton.className = 'back-btn';
            backButton.innerHTML = '<i class="fas fa-arrow-right"></i>';
            backButton.onclick = () => {
                appPage.style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            };
            // تأكد من إزالة زر رجوع قديم قبل الإضافة لتجنب التكرار
            const existingBack = appPage.querySelector('.back-btn');
            if (existingBack) existingBack.remove();
            appPage.querySelector('.app-header').prepend(backButton);

            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('appPage').style.display = 'block';
            document.getElementById('appIcon').src = app.icon;
            document.getElementById('appName').textContent = app.name;
            document.getElementById('appDev').textContent = app.dev;
            document.getElementById('appRating').textContent = app.rating;
            document.getElementById('appStars').innerHTML = '★'.repeat(Math.floor(app.rating)) + '☆'.repeat(5 - Math.floor(app.rating));

            // الصور
            const screenshots = document.getElementById('screenshots');
            screenshots.innerHTML = '';
            app.screenshots.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'screenshot';
                screenshots.appendChild(img);
            });

            document.getElementById('appDesc').textContent = app.desc;

            // التقييمات
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = app.reviews.length ? app.reviews.map(r => `
                <div class="review">
                    <div class="review-header">
                        <div class="reviewer"></div>
                        <div>
                            <div style="font-weight:600;">${r.user}</div>
                            <div class="review-stars">${'★'.repeat(r.stars)}</div>
                        </div>
                    </div>
                    <p>${r.text}</p>
                </div>
            `).join('') : '<p>لا توجد تقييمات بعد.</p>';

            // زر التثبيت الآن يعيد التوجيه إلى صفحة البحث مع معرّف التطبيق و install=1
            const installBtn = document.querySelector('#appPage .install-btn');
            if (installBtn) {
                installBtn.onclick = () => {
                    window.location.href = `search.html?app=${app.id}&install=1`;
                };
            }
        }

        // إغلاق صفحة التثبيت
        function closeInstallPage() {
            document.getElementById('installPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // الرجوع
        window.addEventListener('popstate', () => {
            document.getElementById('appPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        });

        // التبديل بين التبويبات
        document.querySelectorAll('.tab, .nav-item').forEach(el => {
            el.addEventListener('click', () => {
                const tab = el.getAttribute('data-tab');
                if (!tab) return;

                document.querySelectorAll('.tab, .nav-item').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
            });
        });

        // تحسين وظيفة البحث
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTab = document.getElementById('search');
            const searchResults = document.getElementById('searchResults');
            const searchTitle = document.querySelector('#search .section-title');
            
            searchInput.addEventListener('input', debounce((e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length >= 2) { // البحث يبدأ بعد كتابة حرفين على الأقل
                    const filtered = searchApps(query);
                    showSearchResults(filtered);
                } else {
                    hideSearchResults();
                }
            }, 300)); // تأخير البحث لتحسين الأداء
        }

        // دالة البحث في التطبيقات
        function searchApps(query) {
            return apps.filter(app => 
                app.name.toLowerCase().includes(query) || 
                app.dev.toLowerCase().includes(query) || 
                app.desc.toLowerCase().includes(query)
            );
        }

        // عرض نتائج البحث
        function showSearchResults(results) {
            // إخفاء كل التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => 
                tab.classList.remove('active')
            );
            
            // إظهار تبويب البحث
            document.getElementById('search').classList.add('active');
            
            // تحديث عنوان نتائج البحث
            document.querySelector('#search .section-title').textContent = 
                `نتائج البحث (${results.length})`;
            
            // عرض النتائج
            renderApps('searchResults', results, 'grid');
        }

        // إخفاء نتائج البحث
        function hideSearchResults() {
            document.getElementById('search').classList.remove('active');
            document.getElementById('home').classList.add('active');
        }

        // دالة مساعدة لتحسين أداء البحث
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // تحديث دالة تهيئة التطبيق
        function initializeApp() {
            // إذا لم تُحمّل البيانات بعد، أعد المحاولة بعد قليل
            if (!window.apps || !Array.isArray(window.apps)) {
                // جرب مرة أخرى بعد 150ms حتى تصبح البيانات جاهزة
                setTimeout(initializeApp, 150);
                return;
            }

            // تهيئة عرض التطبيقات
            renderApps('suggestedApps', window.apps.slice(0, 4), 'row');
            renderApps('newGames', window.apps.filter(a => a.name.includes('كاندي') || a.name.includes('سبوتيفاي')), 'row');
            renderApps('topDownloads', window.apps, 'grid');
            renderApps('topRated', window.apps.slice().sort((a,b) => (b.rating || 0) - (a.rating || 0)), 'grid');
            renderApps('gameCategories', window.apps.filter(a => a.name.includes('كاندي') || a.name.includes('تيك')), 'grid');
            renderApps('appCategories', window.apps.filter(a => !a.name.includes('كاندي')), 'grid');
            
            // تهيئة القائمة الجانبية
            initializeSidebar();
            
            // تهيئة البحث
            initializeSearch();
        }

        // تهيئة القائمة الجانبية
        function initializeSidebar() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const container = document.querySelector('.container');
            const topBar = document.querySelector('.top-bar');

            // حمايات بسيطة إذا لم يكن أحد العناصر موجوداً
            if (!menuToggle || !sidebar || !container || !topBar) return;

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                container.classList.toggle('sidebar-active');
                topBar.classList.toggle('sidebar-active');
            });

            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) &&
                    !menuToggle.contains(e.target) &&
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    container.classList.remove('sidebar-active');
                    topBar.classList.remove('sidebar-active');
                }
            });
        }

        // تشغيل تهيئة الشريط الجانبي فور تحميل DOM (ليس مشروطًا بوجود window.apps)
        window.addEventListener('DOMContentLoaded', initializeSidebar);

        // تشغيل التطبيق عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initializeApp);

        // إضافة: توجيه إلى صفحة البحث عند الضغط على Enter أو النقر على أيقونة البحث
        (function() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            // اضغط Enter للانتقال إلى صفحة البحث
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const q = searchInput.value.trim();
                    if (q) window.location.href = `search.html?q=${encodeURIComponent(q)}`;
                }
            });

            // إذا أردت أن النقر على أيقونة البحث داخل الحقل يذهب للصفحة (أضف class="search-icon" إلى الـ <i> إن لزم)
            const parent = searchInput.parentElement;
            const icon = parent ? parent.querySelector('.fa-search') : null;
            if (icon) {
                icon.style.cursor = 'pointer';
                icon.addEventListener('click', () => {
                    const q = searchInput.value.trim();
                    if (q) window.location.href = `search.html?q=${encodeURIComponent(q)}`;
                });
            }
        })();
    </script>
</body>
</html>