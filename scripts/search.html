<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بحث - المتجر</title>
  <link rel="stylesheet" href="all-css.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script type="module">
      import { app, db } from './scripts/my-firebase-app/src/firebase-config.js';
      import { collection, getDocs } from "firebase/firestore";

      let apps = [];

      async function fetchApps() {
          const appsCollection = collection(db, "apps");
          const appSnapshot = await getDocs(appsCollection);
          apps = appSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const query = getQuery();
          if (query) performSearch(query);
      }

      window.addEventListener('DOMContentLoaded', fetchApps);
  </script>
</head>
<body>
  <div class="top-bar">
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input id="searchInput" type="text" placeholder="ابحث عن تطبيقات، ألعاب..." />
    </div>
    <a href="index.html" class="profile" title="العودة">العودة</a>
  </div>

  <div class="container" id="mainContent">
    <div id="search" class="tab-content active">
      <div class="section">
        <div class="section-title" id="searchTitle">نتائج البحث</div>
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- صفحة التطبيق (تظهر داخل صفحة البحث) -->
    <div class="app-page" id="appPage" style="display:none;">
      <div class="app-header">
        <button class="back-btn" id="appBackBtn"><i class="fas fa-arrow-right"></i></button>
        <img id="appIcon" src="" alt="أيقونة التطبيق">
        <div class="app-header-info">
          <h1 id="appName"></h1>
          <p id="appDev"></p>
          <div class="app-rating">
            <span id="appStars"></span> <span id="appRating"></span>
          </div>
          <button class="install-btn" id="appInstallBtn">تثبيت</button>
        </div>
      </div>
      <div class="app-details">
        <div class="screenshots" id="screenshots"></div>
        <div class="description" id="appDesc"></div>

        <div class="reviews">
          <h3>تقييمات المستخدمين</h3>
          <div id="reviewsList"></div>
        </div>
      </div>
    </div>

    <!-- صفحة التثبيت -->
    <div class="install-page" id="installPage" style="display:none;">
      <div class="install-header">
        <button class="back-btn" onclick="closeInstallPage()">
          <i class="fas fa-arrow-right"></i>
        </button>
        <h2>تثبيت التطبيق</h2>
      </div>
      <div class="install-content">
        <div class="app-info">
          <img id="installAppIcon" src="" alt="">
          <div class="details">
            <h3 id="installAppName"></h3>
            <p id="installAppDev"></p>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="status" id="installStatus">جاري التحميل...</p>
      </div>
    </div>
  </div>

  <script>
    // بيانات التطبيقات (انسخ نفس مصفوفة apps من index.html أو قم باستدعاء ملف مشترك)
    const apps = [
      { id: 1, name: "واتساب", dev: "Meta", rating: 4.5, icon: "https://via.placeholder.com/100/4CAF50/white?text=WA", screenshots: ["https://via.placeholder.com/300x600"], desc: "تطبيق مراسلة فورية آمن وسريع.", reviews: [{ user: "أحمد", stars: 5, text: "رائع!" }] },
      { id: 2, name: "تيك توك", dev: "ByteDance", rating: 4.7, icon: "https://via.placeholder.com/100/FF0050/white?text=TT", screenshots: ["https://via.placeholder.com/300x600"], desc: "اكتشف فيديوهات قصيرة ممتعة.", reviews: [] },
      { id: 3, name: "سبوتيفاي", dev: "Spotify", rating: 4.6, icon: "https://via.placeholder.com/100/1DB954/white?text=SP", screenshots: ["https://via.placeholder.com/300x600"], desc: "استمع للملايين من الأغاني.", reviews: [] },
      { id: 4, name: "كاندي كراش", dev: "King", rating: 4.4, icon: "https://via.placeholder.com/100/FF6B6B/white?text=CC", screenshots: ["https://via.placeholder.com/300x600"], desc: "لعبة ألغاز ممتعة.", reviews: [] },
      { id: 5, name: "إنستغرام", dev: "Meta", rating: 4.5, icon: "https://via.placeholder.com/100/E4405F/white?text=IG", screenshots: ["https://via.placeholder.com/300x600"], desc: "شارك لحظاتك مع العالم.", reviews: [] },
      { id: 6, name: "يوتيوب", dev: "Google", rating: 4.8, icon: "https://via.placeholder.com/100/FF0000/white?text=YT", screenshots: ["https://via.placeholder.com/300x600"], desc: "شاهد وشارك الفيديوهات.", reviews: [] }
    ];

    // رسم البطاقات
    function renderApps(containerId, appsList) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!appsList.length) {
        container.innerHTML = '<p style="padding:20px;color:var(--text-secondary)">لا توجد نتائج.</p>';
        return;
      }
      appsList.forEach(app => {
        const card = document.createElement('div');
        card.className = 'app-card';
        card.innerHTML = `
          <img src="${app.icon}" alt="${app.name}" class="app-icon">
          <div class="app-info">
            <div class="app-name">${app.name}</div>
            <div class="app-dev">${app.dev}</div>
            <div class="app-rating"><span class="stars">${'★'.repeat(Math.floor(app.rating))}${'☆'.repeat(5 - Math.floor(app.rating))}</span> <span>${app.rating}</span></div>
          </div>
        `;
        // الآن تفتح صفحة التطبيق داخل search.html بدلاً من الانتقال إلى index.html
        card.onclick = () => openApp(app.id);
        container.appendChild(card);
      });
    }

    // قراءة q من العنوان
    function getQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('q') || '';
    }

    function performSearch(q) {
      const query = q.toLowerCase().trim();
      const filtered = apps.filter(a =>
        a.name.toLowerCase().includes(query) ||
        a.dev.toLowerCase().includes(query) ||
        (a.desc && a.desc.toLowerCase().includes(query))
      );
      document.getElementById('searchTitle').textContent = `نتائج البحث (${filtered.length})`;
      renderApps('searchResults', filtered);
    }

    // فتح صفحة التطبيق داخل صفحة البحث
    function openApp(id) {
      const app = apps.find(a => a.id === id);
      if (!app) return;

      // إخفاء نتائج البحث وإظهار صفحة التطبيق
      document.getElementById('search').style.display = 'none';
      const appPage = document.getElementById('appPage');
      appPage.style.display = 'block';

      document.getElementById('appIcon').src = app.icon;
      document.getElementById('appName').textContent = app.name;
      document.getElementById('appDev').textContent = app.dev;
      document.getElementById('appRating').textContent = app.rating;
      document.getElementById('appStars').innerHTML = '★'.repeat(Math.floor(app.rating)) + '☆'.repeat(5 - Math.floor(app.rating));

      // لعرض الصور والوصف
      const screenshots = document.getElementById('screenshots');
      screenshots.innerHTML = '';
      app.screenshots.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'screenshot';
        screenshots.appendChild(img);
      });
      document.getElementById('appDesc').textContent = app.desc;

      // التقييمات
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.innerHTML = app.reviews.length ? app.reviews.map(r => `
        <div class="review">
          <div class="review-header">
            <div class="reviewer"></div>
            <div>
              <div style="font-weight:600;">${r.user}</div>
              <div class="review-stars">${'★'.repeat(r.stars)}</div>
            </div>
          </div>
          <p>${r.text}</p>
        </div>
      `).join('') : '<p>لا توجد تقييمات بعد.</p>';

      // ربط زر التثبيت بهذه النسخة من التطبيق
      const installBtn = document.getElementById('appInstallBtn');
      installBtn.onclick = () => installApp(app);
    }

    // العودة من صفحة التطبيق إلى نتائج البحث
    document.getElementById('appBackBtn').addEventListener('click', () => {
      document.getElementById('appPage').style.display = 'none';
      document.getElementById('search').style.display = 'block';
    });

    // تثبيت التطبيق - عرض صفحة التثبيت داخل search.html
    function installApp(app) {
      const installPage = document.getElementById('installPage');
      const progressBar = document.getElementById('progressBar');
      const status = document.getElementById('installStatus');

      document.getElementById('installAppIcon').src = app.icon;
      document.getElementById('installAppName').textContent = app.name;
      document.getElementById('installAppDev').textContent = app.dev;

      // إظهار صفحة التثبيت وإخفاء صفحة التطبيق
      document.getElementById('appPage').style.display = 'none';
      installPage.style.display = 'block';

      let progress = 0;
      progressBar.style.width = '0%';
      status.textContent = 'جاري التحميل...';

      const interval = setInterval(() => {
        progress += Math.floor(Math.random() * 8) + 3; // تقدم عشوائي ليوهم التحميل
        if (progress > 100) progress = 100;
        progressBar.style.width = `${progress}%`;

        if (progress >= 100) {
          clearInterval(interval);
          status.textContent = 'تم التثبيت بنجاح';
          setTimeout(() => {
            closeInstallPage();
          }, 900);
        }
      }, 150);
    }

    function closeInstallPage() {
      document.getElementById('installPage').style.display = 'none';
      document.getElementById('search').style.display = 'block';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('installStatus').textContent = 'جاري التحميل...';
    }

    // تهيئة الصفحة (تعديل لإدخال دعم app و install من الـ URL)
    (function init() {
      const q = getQuery();
      const input = document.getElementById('searchInput');
      input.value = q;
      input.focus();

      // تنفيذ البحث عند الضغط Enter داخل صفحة البحث
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const newQ = input.value.trim();
          if (newQ) performSearch(newQ);
        }
      });

      // الضغط على أيقونة البحث يقوم بالبحث أيضاً
      const icon = document.querySelector('.search-bar .fa-search');
      if (icon) {
        icon.style.cursor = 'pointer';
        icon.addEventListener('click', () => {
          const newQ = input.value.trim();
          if (newQ) performSearch(newQ);
        });
      }

      // إذا كانت هناك قيمة q قم بالبحث فوراً
      if (q) performSearch(q);

      // قراءة معلمات إضافية: app و install
      const params = new URLSearchParams(window.location.search);
      const appId = params.get('app');
      const installFlag = params.get('install');

      if (appId) {
        // إذا لم تكن نتائج البحث معروضة بعد، تأكد من تحميلها (افتراضي: نفتح صفحة التطبيق مباشرة)
        const id = Number(appId);
        // افتح صفحة التطبيق بعد قليل للتأكد من أن DOM جاهز والنتائج مخفية
        setTimeout(() => {
          openApp(id);
          // إذا كان مطلوب بدء التثبيت فوراً
          if (installFlag === '1') {
            // افتح صفحة التثبيت بعد قليل لإعطاء وقت لإظهار صفحة التطبيق
            setTimeout(() => {
              const appObj = apps.find(a => a.id === id);
              if (appObj) installApp(appObj);
            }, 200);
          }
        }, 100);
      }
    })();
  </script>
</body>
</html>